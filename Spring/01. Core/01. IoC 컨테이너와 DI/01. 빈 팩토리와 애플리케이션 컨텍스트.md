# 빈 팩토리와 애플리케이션 컨텍스트

스프링 애플리케이션에서는 오브젝트의 생성과 관계설정, 사용, 제거 등의 관리 작업을    
애플리케이션 코드 대신 독립된 컨테이너가 담당한다.   
이를 컨테이너가 코드 대신 오브젝트에 대한 제어권을 갖고 있다고 해서 IoC 라고 부른다.   

> 스프링 컨테이너를 IoC 컨테이너라고도 한다.   

스프링에서는 이러한 IoC를 담당하는 컨테이너를 빈 팩토리 또는 애플리케이션 컨텍스트라고 부르기도 한다.   
오브젝트의 생성과 런타임 관계를 설정하는 DI 관접ㅁ으로 볼 떄는 컨테이너를 빈 팩토리라고 한다.   
스프링의 컨테이너는 단순한 DI 작업 보다 더 많은 일을 수 행한다.   
DI 를 위한 빈 팩토리에 비즈니스 애플리케이션 개발에 있어 필요한 여러 기능을 추가한 것을 애플리케이션 컨텍스트라고 한다.   

AppCtx는 그 자체로 IoC와 DI를 위한 빈 팩토리이면서 그 이상의 기능을 제공한다.   

* BeanFactory : 빈 팩토리의 인터페이스
* ApplicationContext : 애플리케이션 컨텍스트의 인터페이스

```java
public interface ApplicationContext extends ListableBeanFactory, HierarchicalBeanFactory,
    MessageSource, ApplicationEventPublisher, ResourcePatternResolver
```

실제로 스프링 컨테이너 또는 IoC 컨테이너라고 말하는 것은,   
바로 이 ApplicationContext 인터페이스를 구현한 클래스의 오브젝트다.   
스프링 애플리케이션은 이러한 AppCtx 를 구현한 최소 하나 이상의 오브젝트를 가지고 있다.   

## 설정 메타정보

스프링 애플리케이션은 POJO 클래스들 중 애플리케이션에서 사용할 것을 선정하고    
이를 IoC 컨테이너가 제어할 수 있도록 설정 메타정보를 제공해야한다.

IoC 컨테이너의 가장 기초적인 역할은 오브젝트를 생성하고 이를 관리하는 것이다.   
스프링 컨테이너가 관리하는 이런 오브젝트는 빈이라고 부른다.
IoC 컨테이너가 필요로 하는 설정 메타정보는 바로 이 빈을 어떻게 만들고 동작하게 할 것인가에 관한 정보다.   

스프링의 설정 정보는 여러가지 방법으로 설정할 수 있다.   
설정 메타정보는 BeanDefinition 인터페이스로 표현되는 순수한 추상 정보이다.   

스프링 IoC 컨테이너, 즉 애플리케이션 컨텍스트는 바로 이 BeanDefintion으로 만들어진 메타정보를 담은   
오브젝트를 사용해 IoC와 DI 작업을 수행한다.   

이러한 메타정보는 XML 이든 소스코드 애노테이션이든 자바 코드이든 프로퍼티 파일이든 상관없이,   
BeanDefinition으로 정의되는 스프링의 설정 메타정보의 내용을 표현한 것이 있다면 무엇이든 사용 가능하다.   

원본의 포맷과 구조, 자료의 특성에 맞게 읽어와 BeanDefinition 오브젝트로 변환할 수 있는   
BeanDefinitionReader 가 그 역할을 담당한다.   
즉, BeanDefinitionReader 를 구현하는 여러가지 구현체들을 통해 설정 메타정보는 어떤 형식으로든 작성될 수 있다.   
BeanDefinition 의 인터페이스로 정의되는 IoC 컨테이너가 사용하는 빈 메타정보는 다음과 같다.   

* 빈 아이디, 이름, 별칭 : 빈 오프젝트를 구분할 수 있는 식별자
* 클래스 또는 클래스 이름 : 빈으로 만들 POJO 클래스 또는 서비스 클래스 정보
* 스코프 : 싱들톤, 프로토타입과 같은 빈의 생ㅅ어 방식과 존재 범위
* 프로퍼티 값 또는 참조 : DI에 사용할 프로퍼티 이름과 값 또는 참조하는 빈의 이름
* 생성자 파라미터 값 또는 참조 : DI에 사용할 생성파 파라미터 이름과 값 또는 참조할 빈의 이름
* 지연된 로딩 여부, 우선 빈 여부, 자동와이어링 여부, 부모 빈 정보, 빈 팩토리 이름 등

스프링 IoC 컨테이너는 각 빈에 대한 정보를 담은 설정 메타정보를 읽어들인 뒤에,   
이를 참고해서 빈 오브젝트를 생성하고 프로퍼티나 생성자를 통해 의존 오브젝트를 주입해주는 DI 작업을 수행한다.   

스프링 IoC 컨테이너는 각 빈에 대한 정보를 담은 설정 메타정보를 읽어들이고(BeanDefinitionReader),
BeanDefinitionReader 는 BeanDefinition 을 생성한다.   
컨테이너는 다시 BeanDefinition을 참고해서 빈을 생성하고 프로퍼티나 생성자를 통해 의존 오브젝트를 주입하는 DI 를 수행한다.    
이 작업을 통해 만들어지고, 연결된 오브젝트들이 모여 하나의 애플리케이션을 구성하게 되는 것이다.   
IoC 컨테이너의 역할은 바로 이것이다.   

## IoC 컨테이너의 종류와 사용 방법

ApplicationContext 인터페이스를 바르게 구현했다면 어떤 클래스든 스프링 IoC 컨테이너로 사용할 수 있다.   
물론 스프링은 이러한 AppCtx 를 구현한 구현체를 다양하게 제공한다.   

### StaticApplicationContext

StaticApplicationContext는 코드를 통해 빈 메타정보를 등록하기 위해 사용한다.    
스프링의 기능에 대한 학습 테스트를 만들 때를 제외하곤 사용되지 않는다.   

### GenericApplicationContext

GenericApplicationContext는 가장 일반적인 애플리케이션 컨텍스트의 구현 클래스다.    
XML, Property 파일의 메타정보를 리더를 통해 읽어들여서 메타정보로 전환한다.   

주로 XmlBeanDefinitionReader를 이용해 메타정보를 처리한다.      
또한 PropertiesBeanDefinitionReader를 활용하기도 한다.

> JUnit 테스트는 테스트 내에서 사용할 수 있도록 애플리케이션 컨텍스트를 자동으로 생성한다.   
> 이때 생성되는 애플리케이션 컨텍스트가 바로 GenricApplicationContext이다.   

### GenericXmlApplicationContext

코드에서 GenericApplicationContext를 사용하는 경우 번거롭게 XmlBeanDefinitionReader 를 
사용하여 빈 메타정보를 전달해줘야 한다.   
반면, GenericXmlApplicationContext를 활용한다면 내장된 XmlBeanDefinitionReader를 사용해,   
경로만 전달하면 자동으로 초기화가 처리된다.   

### WebApplicationContext

WebapplicationContext는 ApplicationContext를 확장한 인터페이스이며,   
이를 구현한 구현체가 주로 사용된다.
이는 웹 환경에서 사용할 때 필요한 기능이 추가된 애플리케이션 컨텍스트다.   
스프링 애플리케이션은 대부분 서블릿 기반 독립 웹으로 만들어진다.   

Xml 설정파일을 사용한다면 XmlWebAApplicationContext를 사용하고,   
어노테이션을 사용한다면 AnnotationConfigWebApplicationContext를 사용한다.   

WebApplicationContext 사용 방법을 이해하려면 스프링의 IoC 컨테이너를 적용했을 때,   
애플리케이션을 작동시키는 방법을 살펴볼 필요가 있다.   

#### 일반적인 스프링 애플리케이션 기동 방법

스프링 IoC 컨테이너는 빈 설정 메타정보를 이용해 빈 오브젝트를 만들고 DI를 수행한다.   
하지만 그것만으로 애플리케이션이 동작하지는 않는다.   
마치 자바 애플리케이션의 main() 메소드처럼 어디선가 특정 빈 오브젝트의 메소드를 호출하여야한다.  

보통 이러한 기동 역할을 맡은 빈을 사용하려면 IoC 컨테이너에서 요청해서 빈 오브젝트를 가져와야 한다.   
이는 적어도 한 번은 IoC 컨테이너에게 요청해서 빈 오브젝트를 가져와야 한다는 의미이다.   
이때는 반드시 getBean() 메소드를 사용하게 될 것이다.(그 이후로는 DI로 서로 연결되어 있어 호출할 필요 없을 것이다)    

IoC 컨테이너의 역할은 이렇게 초기에 빈 오브젝트를 생성하고 DI 한 후     
최초로 애플리케이션을 기동한 빈 하나를 제공해주는 것까지가 그 역할이다.   

#### 웹 애플리케이션의 기동 방법

하지만 웹 애플리케이션은 동작 방식이 근본적으로 다르다.   
독립 자바 프로그램은 자바 VM에게 main() 메소드를 가진 클래스를 시작시켜 달라고 요청한다.   
하지만 웹에서는 main() 메소드를 호출할 방법이 없으며, 사용자도 여럿이다.   
그래서 웹 환경에서는 main() 메소드 대신 서블릿 컨테이너가 endpoint로부터 들어오는    
HTTP 요청을 받아서 해당 요청에 매핑되어 있는 서블릿을 실행시켜주는 방식으로 동작한다.   

웹 애플리케이션에서는 스프링 애플리케이션을 기동시키는 방법은 무엇일까?    
일단 main() 메소드 역할을 하는 서블릿을 만들어두고, 미리 애플리케이션 컨텍스트를 생성하고,   
요청이 서블릿으로 들어올 때마다 getbean()으로 필요한 빈을 가져와 실행해주면 된다.   

서블릿 컨테이너는 클라이언트로부터 들어오는 요청을 받아 서블릿을 동작시켜주는 역할을 한다.   
서블릿은 웹 애플리케이션이 시작될 때 미리 만들어둔 웹 애플리케이션 컨텍스트에게   
빈 오브젝트로 구성된 애플리케이션의 기동 역할 담당 빈을 받아둔다.   
그리고 지정된 메소드를 호출하여 스프링 컨테이너가 DI 방식으로 구성해둔 애플리케이션의 기능이 시작되는 것이다.   

스프링의 웹 환경에서는 애플리케이션 컨텍스트를 생성하고 설정 메타정보로 초기화해주고,    
클라이언트로부터 들어오는 요청마다 적절한 빈을 찾아 이를 실행해주는 DispatcherServlet 이라는 서블릿을 제공한다.   
스프링이 제공해준 서블릿을 web.xml에 등록하는 것만으로 웹 환경에서 스프링 컨테이너가 만들어지고 애플리케이션을    
실행하는 데 필요한 대부분의 준비가 끝난다.   

웹 애플리케이션에서 만들어지는 스프링 IoC 컨테이너는 WebApplicationContext 인터페이스를 구현한 것임을 기억하자.   
WebbApplicationContext의 특징은 자신이 만들어지고 동작하는 환경인 웹 모듈에 대한 정보에 접근할 수 있다는 점이다.   
이를 이용해 웹 환경에서 필요한 정보를 가져오거나, 웹 환경에 컨테이너 자신을 노출시킬 수 있다.    
컨테이너가 웹 환경에 노출되면 웹 모듈에 들어있는 스프링 빈이 아닌 일반 오브젝트와 연동될 수 있다.   

## IoC 컨테이너 계층구조

빈을 담아둘 IoC 컨테이너는 기본적으로 애플리케이션마다 하나씩이면 충분하다.   
하지만 한 개 이상의 IoC 컨테이너를 만들어두고 사용해야 할 경우가 있다.   
바로 트리 모양의 계층구조를 사용할 때 이다.   

모든 애플리케이션 컨텍스트는 부모 애플리케이션 컨텍스트를 가질 수 있다.   
따라서 애플리케이션 컨텍스트의 계층 구조가 만들어질 수 있다.   

계층구조 안의 모든 컨텍스트는 각자 독립적인 설정정보를 이용해 빈 오브젝트를 만들고 관리한다.   
각자 독립적으로 자신이 관리하는 빈을 갖고 있기는 하지만 DI를 위해 빈을 찾을 때는   
부모 컨텍스트의 빈까지 검색할 수 ㅣㅇㅆ다.   

먼저 자신이 관리하는 빈 중에서 필요한 빈을 찾아보고, 없으면 부모 컨텍스트에게 빈을 찾아달라고 요청한다.   
부모 컨텍스트에서도 찾을 수 없으면 부모의 부모, 이런식으로 루트 컨텍스트까지 요청이 전달된다.   

여기서 중요한점은 자식 컨텍스트에게는 빈을 찾아달라고 요청하지 안흔ㄴ다.   
따라서 형제 컨텍스트의 빈도 찾을 수 없다.   

> 이러한 성질을 이용하면 일부 빈을 다시 재설정하고 싶다면,   
> 계층구조를 만들어 자식 컨텍스트에서 그 빈들만 다시 설정하여 사용하면 된다.   

> AOP를 사용한다면 계층구조를 조심해야한다.   
> AOP처럼 컨텍스트 안에 일괄적으로 적용되는 기능 대부분은 해당 컨텍스트로 제한된다.   

> 기본적으로 스프링 웹 애플리케이션은 계층구조로 만들어진다.

## 웹 애프리케이션의 IoC 컨테이너 구성

웹 애플리케이션에서 스프링 IoC 컨테이너를 사용하는 방법은 크게 3가지로 구분된다.
두 가지 방법은 웹 모듈 안에 컨테이너를 두는 것이고,    
나머지 하나는 앤터프라이즈 애플리케이션 레벨에 두는 방법이다.   

웹 애플리케이션 레벨에 등록되는 컨테이너는 보통 루트 웹 애플리케이션 컨텍스트라고 부른다.   
이 컨텍스트는 서블릿 레벨에 등록되는 컨테이너들의 부모 컨테이너가 되고,   
가장 최상단에 위치한 루트 컨텍스트가 되기 때문이다.   

웹 애플리케이션에서는 하나 이상의 스프링 애플리케이션의 프론트 컨트롤러 역할을하는 서블릿이 등록될 수 있다.   
이 서블릿에는 각각 독립적으로 애플리케이션 컨텍스트가 만들어진다.   
따라서 이 서블릿들이 공유하는 빈이 있다면, 이런 빈들은 웹 애플리케이션 레벨의 컨텍스트에 등록하면 된다.   

> 이러면 공통되는 빈들이 서블릿별로 중복돼서 생성되는 걸 방지할 수 있다

하지만 두 개 이상의 스프링용 서블릿을 구분해서 사용하는 경우는 거의 없다.   
그러면 왜 이렇게 계층구조를 만들어서 사용할까?   
이는 전체 애플리케이션에서 웹 기술에 의존적인 부분과 아닌 부분을 구분하기 위해서다.   

스프링을 이용하는 애플리케이션이라고 해서 모든 부분이 반드시 스프링의 기능을 사용해야하는 것은 아니다.   
프리젠테이션 계층은 스프링 외의 기술을 사용할수도 있기 때문이다.   

> 스프링의 유틸리티 메소드를 이용하면 스프링 밖 어디서라도 웹 애플리케이션의 루트 애플리케이션 컨텍스트를 얻을 수 있다
> 그러면 getBean() 메소드를 통해 어떤 빈이든 가져와 쓸 수 있다

```java
WebApplicationContextUtils.getWebApplicationContext(ServletContext sc)
```

### 웹 애플리케이션의 컨텍스트 구성 방법

#### 서블릿 컨텍스트와 루트 애플리케이션 컨텍스트 계층구조

가장 많이 사용되는 기본적인 구성 방법    
스프링 웹 기술을 사용하는 경우 웹 관련 빈들은 서블릿의 컨텍스트에 두고,   
나머지는 루트 애플리케이션 컨텍스트에 등록한다.   
루트 컨텍스트는 모든 서블릿 레벨 컨텍스트의 부모 컨텍스트가 된다.    

#### 루트 애플리케이션 컨텍스트 단일구조

스프링 웹 기술을 이용하지 않고 서드파이 웹 프레임워크나 서비스 엔진을 사용한다면,   
스프링 서블릿을 사용할 이유가 없다.   

#### 서블릿 컨텍스트 단일구조

스프링 웹 기술을 사용하면서 스프링 외의 프레임워크나 서비스 엔진에서,   
스프링 빈을 이용할 생각이 아니라면 루트 애플리케이션 컨텍스트를 생략한다.
대신 모든 빈들을 서블릿에 등록하면 된다.   


### 루트 애플리케이션 컨텍스트 등록

웹 애플리케이션 레벨에 만들어지는 루트 웹 애플리케이션 컨텍스트를 등록하는 가장 간단한 방법은   
서블릿의 이벤트 리스너를 이용하는 것이다.   
스프링은 웹 애플리케이션의 시작과 종료 시 발생하는 이벤트를 처리하는 리스너인   
ServletContextListener를 이용한다.   

ServletContextListener 인터페이스를 구현한 리스너는 웹 애플리케이션 전체에 적용 가능한   
DB 연결 기능이나 로깅 같은 서비스를 만드는 데 유용하게 쓰인다.   
이를 이용해서 웹 애플리케이션이 시작할 때 루트 애플리케이션 컨텍스트를 만들어서 초기화하고,   
웹 애플리케이션이 종료될 때 컨텍스트를 함깨 종료하는 기능을 가진 리스너를 만들 수 있다.   

스프링은 이러한 기능을 가진 리스너인 ContextLoaderListener를 제공한다.   
이를 이용하는 방법은 간단하다.   
웹 애플리케이션의 web.xml 파일 안에 리스너 선언을 넣어주기만 하면 된다.   

ContextLoaderListener는 웹 애플리케이션이 시작할 때 자동으로 루트 애플리케이션 컨텍스트를 만들고 초기화한다.   
그렇다면 이 리스너가 만들어주는 컨텍스트는 어떤 종류이고 어떤 설정을 사용할까?    

루트 애플리케이션 컨텍스트는 웹 애플리케이션의 applicationContext.xml 파일을 디폴트 설정으로 사용한다.   





   